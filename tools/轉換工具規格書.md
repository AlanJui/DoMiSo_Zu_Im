# 轉換工具規格書

## 需求摘要

現有的 Excel 格式之【字庫檔】因有下列之問題，無法直接引用：

- 在【數字台羅】欄內的資料，不應用 - 符號串接，如： lan5 kam1-tsia3，
  應改為： lan5 kam1 tsia3；

- 儲存格內不可有 / 符號，如：tsann7 hi5/tsann7 hu5 。雖人皆知，此表兩種發音；但目前的電腦讀不懂。以中州韻來講，可能會發生不可預期的【誤解】；

- 資料之唯一性未達標，【漢字】與【台羅拼音】相同之資料太多，每回佈署作業都會遭【小狼毫】
發出警告，恐有未知之風險問題。

基於上述三大問題，原檔需使用工具矯正資料問題，加以【正規化】，以便符合【中州韻輸入方案】之【字典檔】格式。


## 需求描述

### 過瀘問題資料

過濾【入聲尾韻】之【調號】為【1】，之台羅音標（正規式： [ptkh]1）。

針對【中州韻輸入方案字庫】工作表中 D 欄的資料（起自 D2 儲存格），進行過濾篩選。 將儲存格內存之【簡式台羅音標】：自右而左數，第2個字元是 [p, t, k, h] 中的任一個； 調號數值是 [1, 4, 8] 中的任一個。不論【調號】值為何，均變更為 0。

```bash
xform/([ptkh])1/${1}0/
```

【篩選條件】：倒數第 2 個字元 ∈ {p,t,k,h}，且最後 1 個字元（調號）∈ {1,4,8}

### 置放轉換結果

（1）在 D 欄與 E 欄之間插入新欄，【欄標題】命名為：【調整後台羅音標】；

（2）將轉換後的結果置於【調整後台羅音標】欄內；

（3）為【瀏覽便利性】，有調整轉換之儲存格，需變更格式：儲存格底色：用【淡黄色】，字體顏色：用【紅色】。此作法可令資料查核時，令人容易辨識那些儲存格的資料為經轉換後的結果。

    - 淡黃色底（FFFF99）
    - 紅色字體（#FF0000）

### 將單一資料分成兩筆

【儲存格內容】置入【/】符號之問題資料，需進行更正，分割成多筆資料。

|  A  |  B  |  C  |  D  |  E  |  F  |  G  |
|-----|-----|-----|-----|-----|-----|-----|
| 序號 | 薦字 | 臺羅拼音 | 數字臺羅 | 調整後台羅音標 | 135注音 | 備註 |
| 24 | 㨻魚 | tsānn hî/tsānn hû | tsann7 hi5/tsann7 hu5 | ㄗㄥㄚ+ ㄏㄧˇ/ㄗㄥㄚ+ ㄏㄨˇ	 | 斜線分兩列 |

如上舉例，【調整後台羅音標】欄（即 E 欄）之資料，內含值為：【tsann7 hi5/tsann7 hu5】，每個【/】符號代表，需多分開出一筆新資料錄（Data Record），其【作業程序】如下：

1. 檢查【儲存格內容】是否含有【/】符號，若【否】則終止作業；
2. 求算【/】符號總數，預估將分割之【總筆數】，以此例言，有 1 筆；
3. 依符號【/】切割【儲存格內容】，以此例言，有：(切割1) tsann7 hi5; (切割2) tsann7 hu5；
4. 在 Excel 新增一筆資料鍵，置於原 row 之後；
5. 將各欄資料依如下規則置入：
   - 序號（A欄）：依原值改【-n+1】，如：原【序號】欄值為【24】，則𦋠入【24-1】；
   - 薦字（B欄）：將原值抄入此處；
   - 台羅拼音（C欄）：將原值抄入此處；
   - 數字台羅（D欄）：將原值抄入此處；
   - 調整後台羅音標（E欄）：將【切割2】值抄入此處，如：tsann7 hu5；
   - 135注音（F欄）：將原值抄入此處；
   - 備註（G欄）：空值
6. 再次回到原【儲存格內容】所在 row ，將切割後之【切割1】（如：tsann7 hi5）取代原 E 欄值；
7. 儲存檔案。

---

## 設計規格

### 工作目錄路徑：

因 ChatGPT5 作業環境：採用 Linux 特性，其所提供之程式碼，需用 Python Script 之【r字串】進行變更，以便能於 Windows 環境作業。

**【ChatGPT5程式碼】：**

```bash
INPUT_PATH = "/mnt/data/python_in_excel.xlsx"
OUTPUT_PATH = "/mnt/data/python_in_excel_with_conversion.xlsx"
```

**【Windows作業程式碼】：**

```bash
INPUT_PATH  = r"c:\work\DoMiSo_Zu_Im\tools\python_in_excel.xlsx"
OUTPUT_PATH = r"c:\work\DoMiSo_Zu_Im\tools\python_in_excel_with_conversion.xlsx"
```


### 安裝 Python 套件

轉換工具以 Python Script 製作，為配合 Excel 整合運作，需有 pandas 與 openpyxl 套件。

- pandas → 處理 Excel 表格資料

- openpyxl → 讀寫 Excel 檔（支援格式、字型、填色）

- re → Python 內建正則表達式模組（不用安裝）

**【啟用Python虛擬作業環境及安裝模組套件】**

```bash
cd c:\work\DoMiSo_Zu_Im
py -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install pandas openpyxl
```

## 工具操作

### 調整台羅音標

使用 python_in_excel.xlsx 活頁檔，産生【調整後台羅音標】欄，將【入聲韻尾】為【p/t/k/h】
，且【調號】值為【1】之音節，變更為【輕聲調】（即【調號】為【0】值）

1. 啟動 Python 虛擬作業環境。

```bash
cd c:\work\DoMiSo_Zu_Im
py -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. 執行工具程式： tan_uan.py

```bash
py .\tools\hun_kuah.py
```

3. 查檢是否有輸出檔案：python_in_excel_with_conversion.xlsx ，並驗證內容是否符合需求規範。

### 調整台羅音標

使用 python_in_excel_with_conversion.xlsx 活頁檔，産生【調整後台羅音標】欄，將【入聲韻尾】為【p/t/k/h】
，且【調號】值為【1】之音節，變更為【輕聲調】（即【調號】為【0】值）

1. 啟動 Python 虛擬作業環境。

```bash
cd c:\work\DoMiSo_Zu_Im
py -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. 執行工具程式： tan_uan.py （轉換）

```bash
py .\tools\tan_uan.py
```

3. 查檢是否有輸出檔案：python_in_excel_conversion.xlsx ，並驗證內容是否符合需求規範。

### 調整台羅音標

使用 python_in_excel_with_conversion.xlsx 活頁檔，將【調整後台羅音標】欄內，使用符號【/】
儲存多筆拼音音節資料，進行資料紀錄分割作業。

1. 啟動 Python 虛擬作業環境。

若 Python 虛擬作業環境尚未啟用，則執行以下指令：

```bash
cd c:\work\DoMiSo_Zu_Im
py -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. 執行工具程式： hun_kuah.py （分割）

```bash
py .\tools\hun_kuah.py
```

3. 查檢是否有輸出檔案：python_in_excel_split.xlsx ，並驗證內容是否符合需求規範。
